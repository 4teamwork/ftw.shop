<tal:def i18n:domain="ftw.shop">
    <tal:shopitems repeat="item view/getItemDatas">

        <div class="listItem"
        	tal:define="normalizeString nocall: context/@@plone/normalizeString">
            
            <div class="listItemImage" tal:condition="item/imageTag">
                <a href="#" tal:attributes="href item/url">
                <img src="" tal:replace="structure item/imageTag" /></a>
            </div>

            <div class="listItemHeading">
                <h2><a href="#" tal:content="item/title" tal:attributes="href item/url" /></h2>
            </div>

            <p class="listItemBody">
                <span tal:replace="item/description" />
                <a href="#" tal:attributes="href item/url" i18n:translate="label_more_link">More</a>
            </p>
            
            
            <!-- Single Item with no Variations -->
            <div class="listItemTable" tal:condition="not:item/hasVariations">
                <table class="shopItemTable">
                    <tr>
                        <th i18n:translate="label_order_number">Order number</th>
                        <th colspan="2" i18n:translate="label_price">Price</th>
                    </tr>
                    <tr>
                        <td tal:content="item/order_number" />
                        <td tal:content="item/price" />
                        <td>
                            <form tal:attributes="action string:${item/url}/addtocart">
                                <input type="hidden" name="skuCode" tal:attributes="value item/order_number"/>
                                <input type="text" size="2" name="quantity:int" value="1"/>
                                <input name="addtocart" type="submit" value="Add to cart"/>
                                
                            </form>
                        </td>
                    </tr>
                </table>
            </div>



			<!-- One Variation Attribute -->
            <div class="variation-toplevel-group" 
                 tal:condition="python:item['hasVariations'] and len(varConf.getVariationAttributes()) == 1" 
			     tal:define="varConf item/varConf">
				<form tal:attributes="action string:${item/url}/addtocart">
					<fieldset>
						<legend>Bestellung</legend>
						<p>
							<label tal:content="python:varConf.getVariationAttributes()[0]">Farbe</label>
							<select name="var1choice">
								<option tal:repeat="varValue1 varConf/getVariation1Values"
									tal:content="varValue1" tal:attributes="value python:normalizeString(varValue1)">Blau</option>
							</select>
						</p>
						<p>
							<label>Menge</label>
							<input name="quantity:int" type="text" value="1" size="2" />
							<input name="addtocart" type="submit" value="Add to cart" />
						</p>
					</fieldset>
				</form>
                 
                 <table id="itemDataTable" tal:define="varDict varConf/getVariationDict">
	                 <thead>
		                 <th>Variation</th>
                         <th i18n:translate="label_price">Price</th>
                         <th i18n:translate="label_stock">Stock</th>
                         <th i18n:translate="label_sku_code">SKU code</th>
	                 </thead>
	                 <tbody>
		                 <tr tal:repeat="vkey varDict" tal:attributes="id vkey">
		                 <td tal:content="python:varConf.getPrettyName(vkey)"></td>
		                 <td tal:content="python: varDict[vkey]['price']"></td>
		                 <td tal:content="python: varDict[vkey]['stock']"></td>
		                 <td tal:content="python: varDict[vkey]['skuCode']"></td>
		                 </tr>
	                 </tbody>
                 </table>
             </div>


            
			<!-- Two Variation Attributes -->
            <div class="variation-toplevel-group" 
                 tal:condition="python:item['hasVariations'] and len(varConf.getVariationAttributes()) > 1" 
			     tal:define="varConf item/varConf">
				<form tal:attributes="action string:${item/url}/addtocart">
					<fieldset>
						<legend>Bestellung</legend>
						<p>
							<label tal:content="python:varConf.getVariationAttributes()[0]">Farbe</label>
							<select name="var1choice">
								<option tal:repeat="varValue1 varConf/getVariation1Values"
									tal:content="varValue1" tal:attributes="value python:normalizeString(varValue1)">Blau</option>
							</select>
						</p>
						<p>
							<label tal:content="python:varConf.getVariationAttributes()[1]">Gr√∂sse</label>
							<select name="var2choice">
								<option tal:repeat="varValue2 varConf/getVariation2Values"
									tal:content="varValue2" tal:attributes="value python:normalizeString(varValue2)">S</option>
							</select>
						</p>
						<p>
							<label>Menge</label>
							<input name="quantity:int" type="text" value="1" size="2" />
							<input name="addtocart" type="submit" value="Add to cart" />
						</p>
					</fieldset>
				</form>
                 
                 <table id="itemDataTable" tal:define="varDict varConf/getVariationDict">
	                 <thead>
		                 <th>Variation</th>
                         <th i18n:translate="label_price">Price</th>
                         <th i18n:translate="label_stock">Stock</th>
                         <th i18n:translate="label_sku_code">SKU code</th>
	                 </thead>
	                 <tbody>
		                 <tr tal:repeat="vkey varDict" tal:attributes="id vkey">
		                 <td tal:content="python:varConf.getPrettyName(vkey)"></td>
		                 <td tal:content="python: varDict[vkey]['price']"></td>
		                 <td tal:content="python: varDict[vkey]['stock']"></td>
		                 <td tal:content="python: varDict[vkey]['skuCode']"></td>
		                 </tr>
	                 </tbody>
                 </table>
             </div>


         </div>
     </tal:shopitems>
     
      <script type="text/javascript">
		    jq("select").change(function () {
		          var varkey;
		          if (jq("select[name=var2choice]").length == 0) {
		              // We only have one variation
			          varkey = jq("select[name=var1choice] option:selected").attr("value"); 
			      }
			      else {
			          // We've got two variations
			          varkey = jq("select[name=var1choice] option:selected").attr("value") + "-" + 
			          		   jq("select[name=var2choice] option:selected").attr("value"); 
			      }
			          jq("table#itemDataTable tr").hide();
			          jq("table#itemDataTable tr").each( function() {
			          		if (varkey == jq(this).attr("id")) {
			          			jq(this).show();
			          			}
			          		});
		     }).change();
		</script>

     <script type="text/javascript">
     jq(function() {
         jq('input[name=addtocart]').click(function(event) {
             event.preventDefault();
             // Get the containing form's action URL
             var url = jq(this).parent().parent().parent().attr('action');
             // Get variation choice(s) from select elements in the same form
             var var1choice = jq(this).parent().parent().find('select[name=var1choice]').find('option:selected').val();
             var var2choice = jq(this).parent().parent().find('select[name=var2choice]').find('option:selected').val();

             if (var1choice == undefined) {
                 // We don't have variations - reference the item by its skuCode
                 var itemdata = {skuCode: jq(this).siblings().filter('input[name=skuCode]').val(),
                                 quantity: jq(this).siblings().filter('input[name=quantity:int]').val()};
             }
             else {
                 if (var2choice == undefined) {
                     // We've got one variation
                     var itemdata = {var1choice: var1choice,
                                     quantity: jq(this).siblings().filter('input[name=quantity:int]').val()};
                 }
                 else {
                     // We've got two variations
                     var itemdata = {var1choice: var1choice,
                                     var2choice: var2choice,
                                     quantity: jq(this).siblings().filter('input[name=quantity:int]').val()};
                 }
             }

             jq.getJSON(url + "_ajax", itemdata,
                 function(response) {
                     var portlet_html = response['portlet_html'];
                     var status_message = response['status_message'];
                     jq('.portletCartPortlet').replaceWith(portlet_html);
                     jq('#kssPortalMessage').html(status_message);
                     jq('#kssPortalMessage').fadeIn().delay(2000).fadeOut();
                 });
         });
     });
     </script>
</tal:def>
