<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      i18n:domain="ftw.shop">

<body metal:use-macro="here/main_template/macros/master">

  <div metal:fill-slot="main">
      
      <h1 class="documentFirstHeading" tal:content="context/Title"> 
          <metal:field use-macro="python:here.widget('Title', mode='view')">
          Title
          </metal:field>
      </h1>
      
    <div>



          <!-- One Variation -->
          <form id="variations" method="post"
          tal:attributes="action python:here.absolute_url() + '/edit_variations'"
          tal:define="varConf python:view.getVariationsConfig();
                      normalizeString nocall: context/@@plone/normalizeString"
          tal:condition="python:len(varConf.getVariationAttributes()) == 1">

              <table>
              <thead>
              <tr>
                <th></th><th></th><th i18n:translate="label_price">Price</th>
                <th i18n:translate="label_sku_code_required">SKU code 
                    <span i18n:name="required" class="required" title="Erforderlich" style="color: #f00;">&#x25a0;</span>
                </th>
                <th i18n:translate="label_description">Description</th>
              </tr>
              </thead>
              <tbody>
                <tr tal:repeat="varValue1 varConf/getVariation1Values">
                <tal:v1idx tal:define="v1idx repeat/varValue1/index">

                <tal:vcode tal:define="vcode string:var-${v1idx}">
                  <td tal:content="varValue1">Red</td>
                  <td><input type="checkbox" class="varActiveCheckbox"
                             tal:attributes="name string:${vcode}-active:boolean;
                                      checked python:varConf.getVariationData(v1idx, None, 'active')"/></td>
                  <td><input type="text" class="number"
                      tal:attributes="name string:${vcode}-price;
                                      value python:varConf.getVariationData(v1idx, None, 'price')"/></td>
                  <td><input type="text" class="required uniqueSkuCode"
                      tal:attributes="name string:${vcode}-skuCode:required;
                                      value python:varConf.getVariationData(v1idx, None, 'skuCode')"/>
                  </td>
                  <td><input type="text" tal:attributes="name string:${vcode}-description;
                                      value python:varConf.getVariationData(v1idx, None, 'description')"/>
                  </td>
                  </tal:vcode>

                  </tal:v1idx>
                </tr>
                </tbody>
              </table>

            <input type="submit"/>
            <input type="hidden" name="form.submitted:boolean" value="True" />
          </form>


          <!-- Two Variations -->
          <form id="variations" method="post"
          tal:attributes="action python:here.absolute_url() + '/edit_variations'"
          tal:define="varConf python:view.getVariationsConfig();
                      normalizeString nocall: context/@@plone/normalizeString"
          tal:condition="python:len(varConf.getVariationAttributes()) > 1">
        <div tal:repeat="varValue1 varConf/getVariation1Values" style="border: 1px solid #ccc; background-color: #ddd; margin-bottom: 1em">
            <fieldset>
                <tal:v1idx tal:define="v1idx repeat/varValue1/index">
              <legend>
                  <input name="v1attr" class="attributeLabelInput" size="7" style="font-weight: bolder;" tal:condition="python: varValue1 == varConf.getVariation1Values()[0]" tal:attributes="value python:context.Schema().getField('variation1_attribute').get(context)" />
                  <strong class="attribute-label" tal:condition="python: varValue1 != varConf.getVariation1Values()[0]" tal:content="python:context.Schema().getField('variation1_attribute').get(context)" />
                  <strong><input tal:attributes="name string:v1-value-${v1idx}; value varValue1" /></strong>
              </legend>
              <table class="listing nosort varTable">
              <thead>
              <tr class="">
                <th></th>
                <th>
                    <input name="v2attr" class="attributeLabelInput" style="font-weight: bolder;" size="5%" tal:condition="python: varValue1 == varConf.getVariation1Values()[0]" tal:attributes="value python:context.Schema().getField('variation2_attribute').get(context)" />
                    <strong class="attribute-label" tal:condition="python: varValue1 != varConf.getVariation1Values()[0]" tal:content="python:context.Schema().getField('variation2_attribute').get(context)" />
                
                </th>
                <th i18n:translate="label_price">Price</th>
                <th i18n:translate="label_sku_code_required">SKU code 
                    <span i18n:name="required" class="required" title="Erforderlich" style="color: #f00;">&#x25a0;</span>
                </th>
                <th i18n:translate="label_description">Description</th>
                <th></th>
              </tr>
              </thead>
              <tbody class="sortable">
                <tr tal:repeat="varValue2 varConf/getVariation2Values" class="combination">
                <tal:v2idx tal:define="v2idx repeat/varValue2/index">
                  <tal:vcode tal:define="vcode string:var-${v1idx}-${v2idx}">
                  <td width="1%" style="text-align: center;">
                      <input type="checkbox" class="varActiveCheckbox"
                      tal:attributes="name string:${vcode}-active:boolean;
                                      checked python:varConf.getVariationData(v1idx, v2idx, 'active')"/></td>

                  <td width="5%" tal:condition="python: varValue1 == varConf.getVariation1Values()[0]">
                      <input style="width: 100%" class="attributeLabelInput"
                             tal:attributes="name string:v2-value-${v2idx}; value varValue2"/>
                  </td>
                  <td width="5%" class="attribute-label" 
                                 tal:condition="python: varValue1 != varConf.getVariation1Values()[0]"
                                 tal:content="varValue2"></td>

                  <td width="3%" >
                      <input type="text" class="number" size="3%"
                             tal:attributes="name string:${vcode}-price;
                                             value python:varConf.getVariationData(v1idx, v2idx, 'price')"/></td>
                  <td width="%4">
                      <input type="text" class="required uniqueSkuCode" style="width:100%"
                             tal:attributes="name string:${vcode}-skuCode:required;
                                             value python:varConf.getVariationData(v1idx, v2idx, 'skuCode')"/>
                  </td>
                  <td>
                      <input type="text" style="width:100%"
                             tal:attributes="name string:${vcode}-description;
                                             value python:varConf.getVariationData(v2idx, v2idx, 'description')"/>
                  </td>
                  <td width="15%">
                      <tal:controls tal:condition="python:repeat['varValue1'].index == 0">
                        <img class="del-variant" src="++resource++ftw-shop-resources/16x16-delete.png" title="Variante entfernen"/>
                        <img class="add-variant" src="++resource++ftw-shop-resources/16x16-add.png" title="Variante hinzufügen"/>
                        <img class="drag-variant" src="++resource++ftw-shop-resources/16x16-drag.png" title="Variante verschieben"/>
                      </tal:controls>
                      
                  </td>
                    </tal:vcode>
                  </tal:v2idx>
                </tr>

                </tbody>
              </table>
              </tal:v1idx>
            </fieldset>
            <span class="del-attribute">Attribut löschen <img src="++resource++ftw-shop-resources/24x24-delete.png" /></span>
            </div>
            <div style="border: 1px solid #ccc; background-color: #ddd; margin-bottom: 1em">
                <fieldset>
                    <span class="add-attribute"><img src="++resource++ftw-shop-resources/24x24-add.png" />Attribut hinzufügen</span>
                </fieldset>
            </div>
            <input type="submit" name="form.button.save" value="Save"/>
            <input type="hidden" name="form.submitted:boolean" value="True" />
          </form>




          <script type="text/javascript">
            jq(function () {

                var update_vcodes = function () {
                    // Updates all vcodes in the inputs name attributes
                    jq('.varTable').each(function(tbl_idx, tbl) {
                        var rows = jq(tbl).find('tr');
                        rows.each(function(row_idx, row) {
                            var vcode = tbl_idx + '-' + (row_idx - 1)
                            var inputs = jq(row).find('input');
                            inputs.each(function() {
                                if (jq(this).hasClass('attributeLabelInput')) {
                                    var new_name = "v2-value-" + (row_idx - 1);
                                }
                                else {
                                    var old_name = jq(this).attr('name');
                                    var old_v1idx = old_name.split('-')[1];
                                    var old_v2idx = old_name.split('-')[2];
                                    var old_vcode = old_v1idx + '-' + old_v2idx;
                                    var new_name = old_name.replace(old_vcode, vcode);
                                }
                                jq(this).attr('name', new_name);
                            });
                        });
                    });
                };

                  // Add a new attribute
                  jq('.add-attribute').live('click', function(event) {
                      var attr_template = jq('.attribute-template');
                      attr_template.removeClass('attribute-template');
                      attr_template.addClass('attribute');
                      attr_template.css('display', 'block');
                  });

                  // Toggle disabled status of the row's input fields
                  jq('.varActiveCheckbox').live('click', function(event) {
                      var row = jq(this).parents('tr');
                      row.find('input').not('.varActiveCheckbox').not('.attributeLabelInput').each(function() {
                          var current_val = jq(this).attr('disabled');
                          if (current_val === true) {
                              jq(this).removeAttr('disabled');
                          }
                          else {
                              jq(this).attr('disabled', true);
                          }
                      });
                      row.toggleClass('greyed-out');
                  });

                  // Add a new variant
                  jq('.add-variant').live('click', function(event) {
                      var clicked_row = jq(this).parents('tr');
                      var vcode = clicked_row.find('input').first().attr('name').replace('-active:boolean', '').replace('var-', '');
                      var v1_idx = parseInt(vcode.split('-')[0]);
                      var v2_idx = parseInt(vcode.split('-')[1]);
                      var row_from_first_table = jq(jq('form#variations table').first().find('tr')[v2_idx + 1]);

                      var tables = jq('.varTable');
                      tables.each(function(tbl_idx, tbl_element) {
                          var rows = jq(this).find('tr');
                          var matching_row = jq(rows[v2_idx + 1]); // + 1 because first one is header row
                          var new_row = matching_row.clone();
                          matching_row.after(new_row);
                          new_row.find('input').each(function() {
                              jq(this).val('');
                          });
                          new_row.find('.attribute-label').first().text('Neue Variante');

                      });
                      var added_row = row_from_first_table.next();
                      added_row.find('.attributeLabelInput').val('Neue Variante');

                      update_vcodes();

                  });


                  // Delete a variant
                  jq('.del-variant').live('click', function(event) {
                      var clicked_row = jq(this).parents('tr');
                      var vcode = clicked_row.find('input').first().attr('name').replace('-active:boolean', '').replace('var-', '');
                      var v1_idx = parseInt(vcode.split('-')[0]);
                      var v2_idx = parseInt(vcode.split('-')[1]);
                      var row_from_first_table = jq(jq('form#variations table').first().find('tr')[v2_idx + 1]);

                      var tables = jq('.varTable');
                      tables.each(function(tbl_idx, tbl_element) {
                          var rows = jq(this).find('tr');
                          var matching_row = jq(rows[v2_idx + 1]); // + 1 because first one is header row
                          matching_row.remove();
                      });

                      update_vcodes();

                  });

                  // Delete an attribute
                  jq('.del-attribute').live('click', function(event) {
                      var attr = jq(this).parent();
                      attr.slideUp().delay(500).remove();
                  });

                  // Store old variant name if it's about to be renamed
                  jq('input.attributeLabelInput').live('focus', function(event) {
                      jq(this).data('old_value', jq(this).val());
                  });

                  // Rename all occurences of the variant
                  jq('input.attributeLabelInput').live('change', function(event) {
                      var new_variant_name = jq(this).val();
                      var v2_idx = parseInt(jq(this).attr('name').replace('v2-value-', ''));
                      var linked_labels = jq('.varTable tr:nth-child(' + (v2_idx + 1) +') .attribute-label');

                      jq(linked_labels).each(function () {
                          var el = jq(this);
                          el.text(new_variant_name);
                      });

                  });
                  
                // Make the combinations sortable by the user  
                jq( ".sortable" ).sortable({
                 revert: true,
                 handle: ".drag-variant",
                 axis: "y",
                 opacity: 0.8,
                 containment: "parent",
                 update: function(event, ui) {
                     update_vcodes();
                 }
                 
                });
              });
              

              </script>


              <!-- <script type="text/javascript" src="http://dev.jquery.com/view/trunk/plugins/validate/jquery.validate.js"></script>
              <script>
              jQuery.validator.addMethod("uniqueSkuCode", 
                    function(value, element) {
                        other_sku_fields = jq('.uniqueSkuCode').not(element);
                        var existing_sku_codes = new Array(0);
                        for (var i=0; i<other_sku_fields.length; i++) {
                            existing_sku_codes.push(other_sku_fields[i].value);
                        }
                        if(jq.inArray(value, existing_sku_codes) > -1 && jq(element).parents('tr').find('input[type=checkbox]').attr('checked') === true) {
                            return false; 
                            }
                        else { 
                            return true; 
                            }
                        }, 
                    "SKU code must be unique");

              jq(document).ready(function($){
                $("#variations").validate();
              });
          </script> -->

    </div>

  </div>
</body>
</html>